name: "Deploy HTTP MCP Server to Azure App Service"

on:
  push:
    tags:
      - "http-v*"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

env:
  AZURE_WEBAPP_NAME: datafactory-mcp-http # Set this to your App Service name
  AZURE_WEBAPP_PACKAGE_PATH: "./publish"
  DOTNET_VERSION: "10.0.x"
  PROJECT_PATH: "DataFactory.MCP.Http/DataFactory.MCP.Http.csproj"

jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Get Version from Tag"
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="manual-$(date +'%Y%m%d-%H%M%S')"
          else
            # Extract version from tag (http-v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF#refs/tags/http-v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: "Setup .NET"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: "Restore dependencies"
        run: dotnet restore ${{ env.PROJECT_PATH }}

      - name: "Build"
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

      - name: "Publish"
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --no-build --output ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: "Upload artifact"
        uses: actions/upload-artifact@v4
        with:
          name: webapp
          path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

    outputs:
      version: ${{ steps.version.outputs.version }}

  deploy:
    name: "Deploy to Azure App Service"
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: "Download artifact"
        uses: actions/download-artifact@v4
        with:
          name: webapp
          path: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: "Azure Login"
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: "Deploy to Azure Web App"
        id: deploy
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          package: ${{ env.AZURE_WEBAPP_PACKAGE_PATH }}

      - name: "Deployment Summary"
        run: |
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**App Service:** \`${{ env.AZURE_WEBAPP_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.deploy.outputs.webapp-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
  #       uses: azure/container-apps-deploy-action@v1
  #       with:
  #         containerAppName: datafactory-mcp-http
  #         resourceGroup: ${{ secrets.AZURE_RESOURCE_GROUP }}
  #         imageToDeploy: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.version }}
