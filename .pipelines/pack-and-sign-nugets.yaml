#################################################################################
#                               OneBranch Pipelines                             #
# Pack and Sign DataFactory.MCP NuGet Packages                                  #
# Documentation:  https://aka.ms/obpipelines                                    #
# Yaml Schema:    https://aka.ms/obpipelines/yaml/schema                        #
# Retail Tasks:   https://aka.ms/obpipelines/tasks                              #
# Support:        https://aka.ms/onebranchsup                                   #
#################################################################################

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - DataFactory.MCP/*

pr:
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - DataFactory.MCP/*

parameters:
  - name: "debug"
    displayName: "Enable debug output"
    type: boolean
    default: false

variables:
  CDP_DEFINITION_BUILD_COUNT: $[counter('', 0)] # needed for onebranch.pipeline.version task
  system.debug: ${{ parameters.debug }}
  ENABLE_PRS_DELAYSIGN: 1
  BuildConfiguration: "Release"
  DataFactorySourceDir: ""
  REPOROOT: $(Build.SourcesDirectory)
  OUTPUTROOT: $(Build.SourcesDirectory)\out
  WindowsContainerImage: "onebranch.azurecr.io/windows/ltsc2022/vse2022:latest"

resources:
  repositories:
    - repository: templates
      type: git
      name: OneBranch.Pipelines/GovernedTemplates
      ref: refs/heads/main

extends:
  template: v2/OneBranch.Official.CrossPlat.yml@templates
  parameters:
    featureFlags:
      WindowsHostVersion: "1ESWindows2022"

    globalSdl:
      tsa:
        enabled: true
      credscan:
        enabled: true
      policheck:
        enabled: true
        break: false
      armory:
        enabled: true
        break: true
      binskim:
        enabled: true
        break: true

    stages:
      - stage: build
        jobs:
          - job: main
            pool:
              type: windows

            variables:
              ob_outputDirectory: "$(Build.SourcesDirectory)/out"
              ob_sdl_binskim_break: true
              ob_symbolsPublishing_enabled: true
              ob_nugetPublishing_enabled: true
              # Force NuGet to use only our config
              NUGET_PACKAGES: "$(Agent.TempDirectory)/.nuget/packages"
              DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "true"
              DOTNET_CLI_TELEMETRY_OPTOUT: "true"

            steps:
              - task: UseDotNet@2
                displayName: "Install .NET SDK"
                inputs:
                  packageType: "sdk"
                  version: "10.0.x"
                  includePreviewVersions: true

              - task: PowerShell@2
                displayName: "Update version in server.json and README.md"
                inputs:
                  targetType: "filePath"
                  filePath: "$(Build.SourcesDirectory)/Update-ServerVersion.ps1"
                  workingDirectory: "$(Build.SourcesDirectory)"
                  pwsh: true
                continueOnError: false

              - task: DotNetCoreCLI@2
                displayName: "Restore packages"
                inputs:
                  command: "restore"
                  projects: "$(Build.SourcesDirectory)/DataFactory.MCP/DataFactory.MCP.csproj"
                  feedsToUse: "config"
                  nugetConfigPath: "$(Build.SourcesDirectory)/nuget.config"
                  verbosityRestore: "Normal"
                  noCache: true
                retryCountOnTaskFailure: 3

              - task: DotNetCoreCLI@2
                displayName: "Build project"
                inputs:
                  command: "build"
                  projects: "$(Build.SourcesDirectory)/DataFactory.MCP/DataFactory.MCP.csproj"
                  arguments: "--configuration $(BuildConfiguration) --no-restore"

              # Publish (tool publish output is what gets packed for PackAsTool; we must sign those bits)
              - task: DotNetCoreCLI@2
                displayName: "Publish project (tool payload)"
                inputs:
                  command: "publish"
                  publishWebProjects: false
                  projects: "$(Build.SourcesDirectory)/DataFactory.MCP/DataFactory.MCP.csproj"
                  arguments: "--configuration $(BuildConfiguration) --no-restore --no-build"
                  zipAfterPublish: false

              - task: onebranch.pipeline.signing@1
                displayName: "Sign published binary files"
                inputs:
                  command: "sign"
                  signing_profile: "external_distribution"
                  files_to_sign: |
                    **/*.exe;
                    **/*.dll;
                    **/*.ps1;
                    **/*.psm1;
                    **/*.psd1;
                    !**/ModelContextProtocol.dll;
                    !**/ModelContextProtocol.Core.dll;
                    !**/Microsoft.Extensions.*.dll;
                    !**/Microsoft.Identity.Client.dll;
                    !**/System.*.dll;
                  search_root: "$(Build.SourcesDirectory)\\DataFactory.MCP\\bin\\$(BuildConfiguration)\\net10.0\\publish"

              # Sign 3rd party dlls
              - task: onebranch.pipeline.signing@1
                displayName: "Sign 3rd party dlls (published)"
                inputs:
                  command: "sign"
                  signing_profile: "135020002"
                  files_to_sign: |
                    **/ModelContextProtocol.dll;
                    **/ModelContextProtocol.Core.dll;
                  search_root: "$(Build.SourcesDirectory)\\DataFactory.MCP\\bin\\$(BuildConfiguration)\\net10.0\\publish"

              - task: DotNetCoreCLI@2
                displayName: "Pack NuGet packages"
                inputs:
                  command: "pack"
                  packagesToPack: "$(Build.SourcesDirectory)/DataFactory.MCP/DataFactory.MCP.csproj"
                  configuration: "$(BuildConfiguration)"
                  outputDir: "$(OUTPUTROOT)"
                  nobuild: true
                  includeSymbols: true

              - task: onebranch.pipeline.signing@1
                displayName: "Sign NuGet Packages"
                inputs:
                  command: "sign"
                  signing_profile: "external_distribution"
                  files_to_sign: "*.nupkg;"
                  search_root: "$(OUTPUTROOT)"

              - task: PowerShell@2
                displayName: "List created packages"
                inputs:
                  targetType: inline
                  script: |
                    $out = "$(OUTPUTROOT)"
                    if (Test-Path $out) {
                      Get-ChildItem $out -Filter *.nupkg -Recurse | Select-Object FullName, Length, LastWriteTime | Format-Table -AutoSize | Out-String | Write-Host
                    } else { Write-Host "Output directory not found: $out" }
                continueOnError: true
